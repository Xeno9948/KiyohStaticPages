<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiyoh Page Builder | New Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .liquid-gradient {
            background: linear-gradient(135deg, #fef3c7 0%, #fff7ed 50%, #f0f9ff 100%);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="liquid-gradient text-slate-900 min-h-screen py-12 px-4">

    <main class="max-w-2xl mx-auto">
        <div class="text-center mb-10">
            <div class="inline-flex items-center gap-2 bg-white/50 border border-white/50 px-4 py-1.5 rounded-full mb-4 shadow-sm">
                <span class="flex h-2 w-2 rounded-full bg-blue-500"></span>
                <span class="text-xs font-bold uppercase tracking-widest text-slate-600">Internal Tool</span>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight mb-2">Page Builder</h1>
            <p class="text-slate-500">Submit details to generate a new landing page.</p>
        </div>

        <form id="buildForm" class="glass p-8 md:p-10 rounded-3xl shadow-xl space-y-6">
            
            <!-- Company Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Company Name</label>
                    <input type="text" name="Company Name" required placeholder="e.g. Joe's Plumbing"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Slug (URL path)</label>
                    <input type="text" name="Slug" required placeholder="e.g. joes-plumbing"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
            </div>

            <!-- USP -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Unique Selling Proposition (Headline)</label>
                <input type="text" name="USP" required placeholder="e.g. 24/7 Expert Plumbing in Cape Town"
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Links -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Kiyoh/Review Link</label>
                <input type="url" name="Kiyoh Link" placeholder="https://..."
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Notification Email -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Notification Email</label>
                <input type="email" name="Email" required placeholder="Where to send the live link"
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Upload Hero Image (Optional)</label>
                <div class="relative">
                    <input type="file" id="imageInput" accept="image/*"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition">
                </div>
                <p class="text-xs text-slate-400 mt-2">Image will be resized and optimized automatically.</p>
            </div>

            <!-- Submit -->
            <button type="submit" id="submitBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black hover:shadow-xl transition-all flex justify-center items-center gap-2">
                <span>Generate Page</span>
            </button>
            
            <div id="statusMessage" class="hidden text-center text-sm font-bold"></div>
        </form>
    </main>

    <script>
        const WEBHOOK_URL = "https://moltbot-railway-template-production-79a3.up.railway.app/hooks/agent";
        const AUTH_TOKEN = "vfv7jitsyn8wav9v1il88bi3f5lxmw4q";

        const form = document.getElementById('buildForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMsg = document.getElementById('statusMessage');
        const imageInput = document.getElementById('imageInput');

        // Helper: Resize image and convert to Base64
        const processImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize logic (max 1000px width)
                        const MAX_WIDTH = 1000;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG 0.7 quality
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UI Loading State
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loader"></div> Processing...';
            statusMsg.classList.add('hidden');

            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Handle Image
                if (imageInput.files[0]) {
                    data['heroImage'] = await processImage(imageInput.files[0]);
                }

                // Prepare Moltbot Payload
                const payload = {
                    message: `ACTION: BUILD_LANDING_PAGE DATA: ${JSON.stringify(data)}`
                };

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Bypass CORS check
                    headers: {
                        'Content-Type': 'text/plain', // Allowed in no-cors
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(payload)
                });

                // In no-cors mode, response is opaque (status 0), so we assume success if no error thrown
                statusMsg.textContent = "✅ Submitted! Check your email in a few minutes.";
                    statusMsg.className = "text-center text-sm font-bold text-green-600 mt-4";
                    form.reset();
                } else {
                    throw new Error("Server rejected request");
                }

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "❌ Error: " + err.message;
                statusMsg.className = "text-center text-sm font-bold text-red-500 mt-4";
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Generate Page';
            }
        });
    </script>
</body>
</html>
