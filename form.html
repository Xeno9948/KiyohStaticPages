<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiyoh Page Builder | New Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .liquid-gradient {
            background: linear-gradient(135deg, #fef3c7 0%, #fff7ed 50%, #f0f9ff 100%);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="liquid-gradient text-slate-900 min-h-screen py-12 px-4">

    <main class="max-w-2xl mx-auto">
        <div class="text-center mb-10">
            <div class="inline-flex items-center gap-2 bg-white/50 border border-white/50 px-4 py-1.5 rounded-full mb-4 shadow-sm">
                <span class="flex h-2 w-2 rounded-full bg-blue-500"></span>
                <span class="text-xs font-bold uppercase tracking-widest text-slate-600">Internal Tool</span>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight mb-2">Page Builder</h1>
            <p class="text-slate-500">Submit details to generate a new landing page.</p>
        </div>

        <form id="buildForm" class="glass p-8 md:p-10 rounded-3xl shadow-xl space-y-6">
            
            <!-- Company Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Company Name</label>
                    <input type="text" name="Company Name" required placeholder="e.g. Joe's Plumbing"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Slug (URL path)</label>
                    <input type="text" name="Slug" required placeholder="e.g. joes-plumbing"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
            </div>

            <!-- USP -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Unique Selling Proposition (Headline)</label>
                <input type="text" name="USP" required placeholder="e.g. 24/7 Expert Plumbing in Cape Town"
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Links -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Kiyoh/Review Link</label>
                    <input type="url" name="Kiyoh Link" placeholder="https://..."
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Social Media Links (Comma separated)</label>
                    <input type="text" name="Social Links" placeholder="FB: https://..., Insta: https://..."
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
            </div>

            <!-- Design Instructions -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Design Instructions (Optional)</label>
                <textarea name="Design Instructions" rows="2" placeholder="e.g. Dark mode, use pink accents, minimalistic..."
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></textarea>
            </div>

            <!-- Kiyoh Widget Code -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Kiyoh Widget Code (Iframe/Script)</label>
                <textarea name="Kiyoh Widget" rows="3" placeholder="Paste the <iframe...> or <script...> code here"
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition font-mono text-xs"></textarea>
            </div>

            <!-- Notification Email -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Notification Email</label>
                <input type="email" name="Email" required placeholder="Where to send the live link"
                    class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Upload Hero Image (Optional)</label>
                <div class="relative">
                    <input type="file" id="imageInput" accept="image/*"
                        class="w-full px-4 py-3 rounded-xl bg-white/50 border border-slate-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition">
                </div>
                <p class="text-xs text-slate-400 mt-2">Image will be resized (max 800px) and compressed automatically.</p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black hover:shadow-xl transition-all flex justify-center items-center gap-2">
                <span>Submit Build Request</span>
            </button>
            
            <div id="statusMessage" class="hidden text-center text-sm font-bold"></div>
        </form>
    </main>

    <script>
        const AUTH_TOKEN = "vfv7jitsyn8wav9v1il88bi3f5lxmw4q";
        const WEBHOOK_URL = `https://moltbot-railway-template-production-79a3.up.railway.app/hooks/agent?token=${AUTH_TOKEN}`;

        const form = document.getElementById('buildForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMsg = document.getElementById('statusMessage');
        const imageInput = document.getElementById('imageInput');

        // Robust & Fast Image Processor
        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                // Safety timeout: 10 seconds max
                const timeout = setTimeout(() => reject(new Error("Image processing timed out")), 10000);

                const img = new Image();
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize logic
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Moderate compression
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        
                        clearTimeout(timeout);
                        URL.revokeObjectURL(img.src); // Clean up memory
                        resolve(dataUrl);
                    } catch (e) {
                        clearTimeout(timeout);
                        reject(e);
                    }
                };

                img.onerror = (e) => {
                    clearTimeout(timeout);
                    reject(new Error("Failed to load image data"));
                };

                // Use createObjectURL for speed (avoids reading entire file into base64 string first)
                img.src = URL.createObjectURL(file);
            });
        };

        const getFormData = async () => {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (imageInput.files[0]) {
                submitBtn.innerHTML = '<div class="loader"></div> Compressing Image...';
                data['heroImage'] = await processImage(imageInput.files[0]);
            }
            return data;
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loader"></div> Sending Request...';
            statusMsg.classList.add('hidden');

            try {
                const data = await getFormData();
                
                // Construct the payload expected by Moltbot
                const payload = {
                    message: `ACTION: BUILD_LANDING_PAGE DATA: ${JSON.stringify(data)}`
                };

                // Use Standard CORS request (reliable data transmission)
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                }

                const responseText = await response.text();
                console.log("Server response:", responseText);

                // Success State
                statusMsg.textContent = "✅ Success! Build request sent. Check your email shortly.";
                statusMsg.className = "text-center text-sm font-bold text-green-600 mt-4";
                statusMsg.classList.remove('hidden');
                form.reset();

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "❌ Error: " + err.message + ". Please try again or contact support.";
                statusMsg.className = "text-center text-sm font-bold text-red-500 mt-4";
                statusMsg.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Build Request';
            }
        });
    </script>
</body>
</html>
